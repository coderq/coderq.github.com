<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>CoderQ·博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="个人博客">
<meta property="og:type" content="website">
<meta property="og:title" content="CoderQ·博客">
<meta property="og:url" content="http://coderq.github.io/index.html">
<meta property="og:site_name" content="CoderQ·博客">
<meta property="og:description" content="个人博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CoderQ·博客">
<meta name="twitter:description" content="个人博客">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://7xqex1.com1.z0.glb.clouddn.com/avatar%2F1426483393_DXGAJIiR.jpeg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">CoderQ</a></h1>
		</hgroup>

		
		<p class="header-subtitle">不积硅步无以至千里(旧博客地址：http://blog.coderq.net)</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>標籤</li>
						
						
						<li>關於</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/coderq" title="github">github</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/C/" style="font-size: 10px;">C</a> <a href="/tags/bash/" style="font-size: 10px;">bash</a> <a href="/tags/highlight/" style="font-size: 10px;">highlight</a> <a href="/tags/html/" style="font-size: 10px;">html</a> <a href="/tags/http/" style="font-size: 16.67px;">http</a> <a href="/tags/javascript/" style="font-size: 20px;">javascript</a> <a href="/tags/mac/" style="font-size: 10px;">mac</a> <a href="/tags/mongodb/" style="font-size: 16.67px;">mongodb</a> <a href="/tags/msgpack/" style="font-size: 10px;">msgpack</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/nginx/" style="font-size: 13.33px;">nginx</a> <a href="/tags/node-js/" style="font-size: 13.33px;">node.js</a> <a href="/tags/npm/" style="font-size: 10px;">npm</a> <a href="/tags/opencv/" style="font-size: 10px;">opencv</a> <a href="/tags/orientdb/" style="font-size: 13.33px;">orientdb</a> <a href="/tags/redis/" style="font-size: 16.67px;">redis</a> <a href="/tags/ssl/" style="font-size: 10px;">ssl</a> <a href="/tags/微信/" style="font-size: 10px;">微信</a> <a href="/tags/状态码/" style="font-size: 10px;">状态码</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">我是谁，我从哪里来，我到哪里去？我就是我，是颜色不一样的吃货…</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">CoderQ</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="http://7xqex1.com1.z0.glb.clouddn.com/avatar%2F1426483393_DXGAJIiR.jpeg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">CoderQ</h1>
			</hgroup>
			
			<p class="header-subtitle">不积硅步无以至千里(旧博客地址：http://blog.coderq.net)</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/coderq" title="github">github</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-backend-build" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/20/backend-build/" class="article-date">
  	<time datetime="2016-04-20T00:06:21.000Z" itemprop="datePublished">2016-04-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/20/backend-build/">我是如何构建我的后端服务器的</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近有空的时候一直在整理自己的后端代码，希望整理出一套较为通用的代码，可以运用到大多数的项目中去。现在的项目基本都是前后端分离的，后端只负责提供restful api接口，根据不同的项目，和前端会有不同的集成方式，例如app的后端，基本就是一个独立的项目，我个人的博客后端，我会考虑使用nginx做一个转发，当接收到<code>/</code>到请求时，转发给前端页面处理；当接受到<code>/service</code>请求时，转发给后端处理，这些请求基本上都是前端的ajax请求，避免了跨域的麻烦。后端的代码中我们只要用一个简单的use方法做转发可以将<code>/service</code>的请求转回原地址了。</p>
<p>我的项目目录：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">controller // &#23384;&#20648;&#25511;&#21046;&#22120;&#30340;&#25991;&#20214;&#22841;&#10;library // &#23384;&#20648;&#36890;&#29992;&#20195;&#30721;&#30340;&#25991;&#20214;&#22841;&#10;- error.js // &#36890;&#29992;&#38169;&#35823;&#23450;&#20041;&#10;- helper.js // &#31995;&#32479;&#32423;&#36890;&#29992;&#20989;&#25968;&#23450;&#20041;&#65292;&#20363;&#22914;jwt&#20196;&#29260;&#29983;&#20135;&#21644;&#26657;&#39564;&#10;- middleware.js // &#20013;&#38388;&#20214;&#23450;&#20041;&#10;- util.js // &#24120;&#35268;&#36890;&#29992;&#20989;&#25968;&#23450;&#20041;&#65292;&#19968;&#33324;&#20197;lodash&#25110;&#31995;&#32479;&#20869;&#32622;&#30340;util&#27169;&#22359;&#20026;&#22522;&#30784;&#65292;md5&#31561;&#33258;&#24049;&#24120;&#29992;&#30340;&#26041;&#27861;&#10;model // &#23384;&#20648;mysql&#12289;mongo&#21450;redis&#25968;&#25454;&#27169;&#22411;&#30340;&#25991;&#20214;&#22841;&#10;- mysql // mysql&#10;- mongo // mongodb&#10;- redis // redis&#10;- index.js&#10;node_modules // node.js&#30340;&#27169;&#22359;&#10;router // &#31995;&#32479;&#36335;&#30001;&#10;- v1.js // &#29256;&#26412;1&#30340;&#36335;&#30001;&#10;- v1_1.js // &#29256;&#26412;1.1&#30340;&#36335;&#30001;&#10;- index.js // &#36890;&#36807;use&#26041;&#27861;&#35843;&#29992;&#21508;&#29256;&#26412;&#36335;&#30001;&#10;service // controller&#21644;model&#20043;&#38388;&#30340;&#19994;&#21153;&#36923;&#36753;&#20195;&#30721;&#10;test // &#21333;&#20803;&#27979;&#35797;&#25991;&#20214;&#22841;&#10;.gitignore&#10;app.js // &#21551;&#21160;&#25991;&#20214;&#10;config.js // &#37197;&#32622;&#25991;&#20214;&#10;package.json // &#27169;&#22359;&#37197;&#32622;&#25991;&#20214;&#10;readme.md</span><br></pre></td></tr></table></figure></p>
<p>所有的请求都会经过路由再到达控制器，路由是所有代码内容的第一关，特别是在app项目里面，url一旦发布就难以修改（客户端也可以通过默写热修复的方法处理），url地址的设计好坏对于项目维护很重要。我在定义路由的时候，会有一个总的index.js文件，app.js只要引入这个文件即可，项目就可以访问到所有版本的api。</p>
<p>index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">'use strict'</span>;</span><br><span class="line"><span class="comment">/* jshint node: true */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Mdl = <span class="built_in">require</span>(<span class="string">'../library/middleware'</span>);</span><br><span class="line"><span class="keyword">const</span> Ctr = <span class="built_in">require</span>(<span class="string">'../controller'</span>);</span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>);</span><br><span class="line"><span class="keyword">const</span> v_1 = <span class="built_in">require</span>(<span class="string">'./v1'</span>);</span><br><span class="line"><span class="keyword">const</span> v_1_1 = <span class="built_in">require</span>(<span class="string">'./v1_1'</span>);</span><br><span class="line"><span class="keyword">const</span> v_admin = <span class="built_in">require</span>(<span class="string">'./admin'</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router();</span><br><span class="line"></span><br><span class="line"><span class="comment">// restful api v1</span></span><br><span class="line">router.use(<span class="string">'/1'</span>, v_1.routes(), v_1.allowedMethods());</span><br><span class="line"><span class="comment">// restful api v1.1</span></span><br><span class="line">rotuer.use(<span class="string">'/1.1'</span>, v_1_1.routes(), v_1_1.allowedMethods());</span><br><span class="line"><span class="comment">// manage api</span></span><br><span class="line">router.use(<span class="string">'/admin'</span>, v_admin.routes(), v_admin.allowedMethods());</span><br><span class="line"></span><br><span class="line">router.all(<span class="string">'*'</span>, <span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.status = <span class="number">404</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure></p>
<p>v1.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">'use strict'</span>;</span><br><span class="line"><span class="comment">/* jshint node: true */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Ctr = <span class="built_in">require</span>(<span class="string">'../controller'</span>).v1;</span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>);</span><br><span class="line"><span class="keyword">const</span> v1 = <span class="keyword">new</span> Router();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 增加用户</span></span><br><span class="line">v1.post(<span class="string">'/user'</span>, Ctr.User.create);</span><br><span class="line"><span class="comment">// 删除用户</span></span><br><span class="line">v1.delete(<span class="string">'/user/:user_id'</span>, Ctr.User.delete);</span><br><span class="line"><span class="comment">// 查询用户信息</span></span><br><span class="line">v1.get(<span class="string">'/user/:user_id'</span>, Ctr.User.read);</span><br><span class="line">v1.get(<span class="string">'/user'</span>, Ctr.User.read);</span><br><span class="line"><span class="comment">// 修改用户信息</span></span><br><span class="line">v1.put(<span class="string">'/user/:user_id'</span>, Ctr.User.update);</span><br></pre></td></tr></table></figure></p>
<p>在我的<code>controller</code> <code>service</code> <code>model</code>三个文件夹下，都会有一个<code>index.js</code>的文件，<code>controller</code>会被路由引入，<code>controller</code>又会引入<code>service</code>，<code>service</code>又引入<code>model</code>，最终到达数据库。我比较习惯用一个单独的大写字母来标示一些特殊的集合。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> U = <span class="built_in">require</span>(<span class="string">'../library/util'</span>);</span><br><span class="line"><span class="keyword">const</span> H = <span class="built_in">require</span>(<span class="string">'../library/helper'</span>);</span><br><span class="line"><span class="keyword">const</span> S = <span class="built_in">require</span>(<span class="string">'../library/service'</span>);</span><br><span class="line"><span class="keyword">const</span> M = <span class="built_in">require</span>(<span class="string">'../library/model'</span>);</span><br></pre></td></tr></table></figure>
<p>一开始用这种方法的时候，总会担心别人的批评，因为这种看不出是什么鬼的定义很容易被喷，有点过不去心里的坎，不过后来想想，规则就是人定的，为什么一定要遵守别人的规则，自己觉得好久即可。以前做PHP用think PHP框架也有类似的语法。用一个字母表示一个集合，确实是蛮实用的。</p>
<p><code>service</code>作为服务层，承载着所有增删改查的业务逻辑处理，虽然有模型层把控数据格式，但是模型层很多时候只会返回诸如<code>Validation error</code>之类的单一错误提示，这样的提示很难判定是哪个地方出了异常，所以在数据进入模型层之前，我会对参数做断言判断，而断言的异常情况，会统一定义在<code>library/error.js</code>文件里。</p>
<p>登录验证的服务层<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">exports.verify = <span class="function"><span class="keyword">function</span>*(<span class="params">account, password</span>) </span>&#123;</span><br><span class="line">    assert(H.isAccount(account), <span class="string">'ACCOUNT_INVALID'</span>);</span><br><span class="line">    assert(U.isPassword(password), <span class="string">'PASSWORD_INVALID'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> rs = <span class="keyword">yield</span> M.Mysql.User.findOne(&#123;</span><br><span class="line">        where: &#123; $or: [&#123; mobile: account &#125;, &#123; email: account &#125;] &#125;,</span><br><span class="line">        include: [&#123;</span><br><span class="line">            model: M.Mysql.UserProfile,</span><br><span class="line">            through: &#123;</span><br><span class="line">                attributes: [<span class="string">'gender'</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    assert(rs, <span class="string">'USER_GONE'</span>);</span><br><span class="line">    assert(rs.password == H.generatePassword(password, rs.password_salt), <span class="string">'PASSWORD_ERROR'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> access_token = <span class="keyword">yield</span> H.signToken(U.extend(rs, &#123; password_salt: <span class="literal">null</span> &#125;, U.extend.RN));</span><br><span class="line">    <span class="keyword">let</span> refresh_token = <span class="keyword">yield</span> H.signToken(&#123; user_id: rs._id &#125;, refresh_token_expires);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; access_token: access_token, refresh_token: refresh_token &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>error.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">'use strict'</span>;</span><br><span class="line"><span class="comment">/* jshint node: true */</span></span><br><span class="line"></span><br><span class="line">exports.ACCOUNT_INVALID = &#123;message: <span class="string">'账号无效'</span>, code: <span class="number">400</span>&#125;;</span><br><span class="line">exports.PASSWORD_INVALID = &#123;message: <span class="string">'密码无效'</span>, code: <span class="number">400</span>&#125;;</span><br><span class="line">exports.PASSWORD_ERROR = &#123;message: <span class="string">'密码错误'</span>, code: <span class="number">400</span>&#125;;</span><br><span class="line">exports.USER_GONE = &#123;message: <span class="string">'用户不存在'</span>, code: <span class="number">410</span>&#125;;</span><br><span class="line">exports.PARAM_INVALID = &#123;message: <span class="string">'参数错误'</span>, code: <span class="number">400</span>&#125;;</span><br><span class="line">exports.MOBILE_EXISTS = &#123;message: <span class="string">'手机号码已存在'</span>, code: <span class="number">409</span>&#125;;</span><br><span class="line">exports.EMAIL_EXISTS = &#123;message: <span class="string">'电子邮箱已存在'</span>, code: <span class="number">409</span>&#125;;</span><br><span class="line">exports.OBJECT_ID_INVALID = &#123;message: <span class="string">'无效的查询ID'</span>, code: <span class="number">400</span>&#125;;</span><br><span class="line">exports.EMAIL_INVALID = &#123;message: <span class="string">'电子邮箱格式错误'</span>, code: <span class="number">400</span>&#125;;</span><br><span class="line">exports.MOBILE_INVALID = &#123;message: <span class="string">'手机号码格式错误'</span>, code: <span class="number">400</span>&#125;;</span><br><span class="line">exports.BOOK_GONE = &#123;message: <span class="string">'书籍不存在'</span>, code: <span class="number">400</span>&#125;;</span><br></pre></td></tr></table></figure></p>
<p>有了<code>assert</code>，于是代码里必然要出现<code>try {} catch(e) {}</code>的代码。每个接口都写一遍<code>try catch</code>会很麻烦，既然error可以统一由error.js定义，那么统一处理也是可以的</p>
<p>登录验证的controller<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">exports.verify = H.f(<span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> account = <span class="keyword">this</span>.request.body.account;</span><br><span class="line">	<span class="keyword">let</span> password = <span class="keyword">this</span>.request.body.password;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">let</span> ret = <span class="keyword">yield</span> S.Auth.verify.call(<span class="keyword">this</span>, account, password);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">this</span>.send(<span class="number">200</span>, ret);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>正常来讲，verify这个方法只要返回一个<code>Generator function</code>即可，为了把<code>try catch</code>的代码提取出来，我包多了一层函数用来处理异常。这个函数定义在我的<code>library/helper.js</code>文件里面</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">exports.f = <span class="function"><span class="keyword">function</span>(<span class="params">func, error</span>) </span>&#123;</span><br><span class="line">	error = error || &#123;&#125;;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">yield</span> func.call(<span class="keyword">this</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">			<span class="keyword">let</span> obj = error[e.message] || E[e.message] || &#123;message: C.debug ? e.stack : <span class="string">'未知异常'</span>, code: <span class="number">500</span>&#125;;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">typeof</span> obj.message === <span class="string">'string'</span>) &#123;</span><br><span class="line">				obj.message = &#123;</span><br><span class="line">					code: <span class="number">1</span>,</span><br><span class="line">					message: obj.message</span><br><span class="line">				&#125;;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">this</span>.send(obj.code, obj.message);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>函数的名字主要是为了简短，又想不出太好的命名，就直接给了个<code>f</code>，函数的两个参数，第一个就是传入进来的<code>generator function</code>，第二个是自定义的错误释义，因为有时候我们需要返回的错误解释也许不是error.js里面定义的那个，或者说有时候同样是401的状态码，但是可能是不同情况导致的，例如有可能是令牌过期，也有可能是用户修改了密码，要求重新登录，于是你必须给出不同的释义。</p>
<p>模型层基本用的都是orm框架，较好的把控了数据问题，关系数据都存在mysql数据库，较少的数据存mongo，例如书籍这类树形的数据。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node-js/">node.js</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/node-js/">node.js</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-mongodb-command" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/18/mongodb-command/" class="article-date">
  	<time datetime="2016-04-18T09:26:52.000Z" itemprop="datePublished">2016-04-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/18/mongodb-command/">自己平时使用过的一些mongodb命令记录</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="u6839_u636E_u65E5_u671F_u7EDF_u8BA1_u51FA_u67D0_u4E9B_u624B_u673A_u53F7_u8BB0_u5F55_u6570"><a href="#u6839_u636E_u65E5_u671F_u7EDF_u8BA1_u51FA_u67D0_u4E9B_u624B_u673A_u53F7_u8BB0_u5F55_u6570" class="headerlink" title="根据日期统计出某些手机号记录数"></a>根据日期统计出某些手机号记录数</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data = db.spinetmp.aggregate([</span><br><span class="line">	&#123;$match: &#123;status: <span class="string">'visable'</span>, checkuserid: &#123;$<span class="keyword">in</span>: [<span class="string">'156****5285'</span>, <span class="string">'156****5194'</span>, <span class="string">'137****8875'</span>, <span class="string">'158****1125'</span>]&#125;&#125;&#125;,</span><br><span class="line">	&#123;$project: &#123;mobile: <span class="string">'$checkuserid'</span>, date: &#123;$dateToString: &#123;format: <span class="string">"%Y-%m-%d"</span>, date: <span class="string">"$version"</span> &#125;&#125;&#125;&#125;,</span><br><span class="line">	&#123;$group: &#123;_id: &#123;mobile: <span class="string">'$mobile'</span>, date: <span class="string">"$date"</span>&#125;, count: &#123;$sum: <span class="number">1</span>&#125;&#125;&#125;,</span><br><span class="line">	&#123;$sort: &#123;<span class="string">'_id.mobile'</span>: <span class="number">1</span>, <span class="string">'_id.date'</span>: －<span class="number">1</span>&#125;&#125;</span><br><span class="line">]);</span><br><span class="line"><span class="comment">// 将数据转为csv格式</span></span><br><span class="line">data.map(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> item._id.mobile + <span class="string">','</span> + item._id.date + <span class="string">','</span> + item.count;</span><br><span class="line">&#125;).join(<span class="string">"\n"</span>);</span><br></pre></td></tr></table></figure>
<h2 id="u5012_u51FA_u7528_u6237_u4E66_u5355_u7684_u63CF_u8FF0_u548C_u4E66_u7684_u63A8_u8350_u8BED"><a href="#u5012_u51FA_u7528_u6237_u4E66_u5355_u7684_u63CF_u8FF0_u548C_u4E66_u7684_u63A8_u8350_u8BED" class="headerlink" title="倒出用户书单的描述和书的推荐语"></a>倒出用户书单的描述和书的推荐语</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> users = db.user.find(&#123;mobile_number: &#123;$<span class="keyword">in</span>: [<span class="string">'156****6041'</span>, <span class="string">'155****4511'</span>, <span class="string">'136****5641'</span>]&#125;&#125;, &#123;_id: <span class="number">0</span>, mobile_number: <span class="number">1</span>, user_id: <span class="number">1</span>&#125;);</span><br><span class="line"></span><br><span class="line">users.map(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</span><br><span class="line">	item.floors = db.floor.find(&#123;user_id: item.user_id, type: &#123;$exists: <span class="literal">false</span>&#125;&#125;, &#123;user_id: <span class="number">1</span>, name: <span class="number">1</span>, desc: <span class="number">1</span>, item_list: <span class="number">1</span>&#125;).toArray();</span><br><span class="line">	item.floors = item.floors.map(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</span><br><span class="line">		item.item_list = item.item_list.map(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> db.item.findOne(&#123;bid: item&#125;, &#123;bid: <span class="number">1</span>, title: <span class="number">1</span>, remark: <span class="number">1</span>&#125;);</span><br><span class="line">		&#125;);</span><br><span class="line">		<span class="keyword">return</span> item;</span><br><span class="line">	&#125;);</span><br><span class="line">	<span class="keyword">return</span> item;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="u6839_u636E_u51FA_u7248_u793E_u548C_u4E66_u6392_u51FA_u7528_u6237_u6536_u85CF_u6700_u591A_u7684_u4E66"><a href="#u6839_u636E_u51FA_u7248_u793E_u548C_u4E66_u6392_u51FA_u7528_u6237_u6536_u85CF_u6700_u591A_u7684_u4E66" class="headerlink" title="根据出版社和书排出用户收藏最多的书"></a>根据出版社和书排出用户收藏最多的书</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rs.slaveOk();</span><br><span class="line"><span class="keyword">var</span> data = db.library.aggregate([</span><br><span class="line">	&#123;$group: &#123;_id: &#123;publisher: <span class="string">'$publisher'</span>, bid: <span class="string">'$bid'</span>, title: <span class="string">'$title'</span>&#125;, count: &#123;$sum: <span class="number">1</span>&#125;&#125;&#125;</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// to csv</span></span><br><span class="line">data.toArray().sort(<span class="function"><span class="keyword">function</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> b.count - a.count;</span><br><span class="line">&#125;).map(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> item._id.publisher + <span class="string">','</span> + item._id.bid + <span class="string">','</span> + item._id.title + <span class="string">','</span> + item.count; </span><br><span class="line">&#125;).join(<span class="string">"\n"</span>);</span><br></pre></td></tr></table></figure>
<h2 id="u67E5_u51FA_u6307_u5B9A_u51FA_u7248_u793E_u524D10_u540D_u7684_u4E66_u7C4D"><a href="#u67E5_u51FA_u6307_u5B9A_u51FA_u7248_u793E_u524D10_u540D_u7684_u4E66_u7C4D" class="headerlink" title="查出指定出版社前10名的书籍"></a>查出指定出版社前10名的书籍</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">rs.slaveOk();</span><br><span class="line"><span class="keyword">var</span> publishers = [</span><br><span class="line">	<span class="string">'人民文学出版社'</span>,</span><br><span class="line">	<span class="string">'上海译文出版社'</span>,</span><br><span class="line">	<span class="string">'中华书局'</span>,</span><br><span class="line">	<span class="string">'中信出版社'</span>,</span><br><span class="line">	<span class="string">'商务印书馆'</span>,</span><br><span class="line">	<span class="string">'生活·读书·新知三联书店'</span>,</span><br><span class="line">	<span class="string">'广西师范大学出版社'</span>,</span><br><span class="line">	<span class="string">'译林出版社'</span>,</span><br><span class="line">	<span class="string">'新星出版社'</span>,</span><br><span class="line">	<span class="string">'南海出版公司'</span></span><br><span class="line">];</span><br><span class="line"><span class="keyword">var</span> data = db.library.aggregate([</span><br><span class="line">	&#123;$match: &#123;publisher: &#123;$<span class="keyword">in</span>: publishers&#125;&#125;&#125;,</span><br><span class="line">	&#123;$group: &#123;_id: &#123;publisher: <span class="string">'$publisher'</span>, title: <span class="string">'$title'</span>&#125;, count: &#123;$sum: <span class="number">1</span>&#125;&#125;&#125;</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//findIndex是es6的函数，自己写。。。</span></span><br><span class="line"><span class="keyword">var</span> findIndex = <span class="function"><span class="keyword">function</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> i = <span class="number">0</span>, r;</span><br><span class="line">	<span class="keyword">while</span> (<span class="keyword">this</span>.length &gt; i &amp;&amp; !(r = fn(<span class="keyword">this</span>[i], i, <span class="keyword">this</span>))) i++;</span><br><span class="line">	<span class="keyword">return</span> r ? i : -<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// to csv</span></span><br><span class="line">data</span><br><span class="line"><span class="comment">// 对象数组化</span></span><br><span class="line">.toArray()</span><br><span class="line"><span class="comment">// 按出版社归类排序</span></span><br><span class="line">.sort(<span class="function"><span class="keyword">function</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (publishers.indexOf(a._id.publisher) - publishers.indexOf(b._id.publisher)) || (b.count - a.count);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 过滤出前10的书籍，这里可以用另一个数组对象来存储数据，减少运算步骤。</span></span><br><span class="line">.filter(<span class="function"><span class="keyword">function</span>(<span class="params">item, index, ary</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> index &lt; (findIndex.call(ary, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> item._id.publisher === data._id.publisher;</span><br><span class="line">	&#125;) + <span class="number">10</span>);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 格式化</span></span><br><span class="line">.map(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> item._id.publisher + <span class="string">','</span> + item._id.title + <span class="string">','</span> + item.count; </span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// toString</span></span><br><span class="line">.join(<span class="string">"\n"</span>);</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongodb/">mongodb</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/mongodb/">mongodb</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-mysql-commander" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/18/mysql-commander/" class="article-date">
  	<time datetime="2016-04-17T23:41:59.000Z" itemprop="datePublished">2016-04-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/18/mysql-commander/">Mysql的一些语法</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>添加一个主键并将其放到表的最前<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE `test`.`user` &#10;ADD COLUMN `id` INT UNSIGNED NOT NULL COMMENT &#39;&#20027;&#38190;&#39; FIRST,&#10;ADD PRIMARY KEY (`id`);</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-javascript-skill" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/13/javascript-skill/" class="article-date">
  	<time datetime="2016-04-12T23:33:29.000Z" itemprop="datePublished">2016-04-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/13/javascript-skill/">javascript的一些常用技能</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="u53CD_u8F6C_u4E00_u4E2A_u5B57_u7B26_u4E32"><a href="#u53CD_u8F6C_u4E00_u4E2A_u5B57_u7B26_u4E32" class="headerlink" title="反转一个字符串"></a>反转一个字符串</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'123456789'</span>.split(<span class="string">''</span>).revert().join(<span class="string">''</span>); <span class="comment">// '987654321';</span></span><br></pre></td></tr></table></figure>
<h2 id="u53BB_u91CD"><a href="#u53BB_u91CD" class="headerlink" title="去重"></a>去重</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'11122213434'</span>.split(<span class="string">''</span>).filter(<span class="function"><span class="keyword">function</span>(<span class="params">item, index, ary</span>) </span>&#123;<span class="keyword">return</span> index == ary.indexOf(item)&#125;).join(<span class="string">''</span>); <span class="comment">// '1234'</span></span><br></pre></td></tr></table></figure>
<h2 id="u591A_u7EF4_u6570_u7EC4-_26gt_3B_u5B57_u7B26_u4E32"><a href="#u591A_u7EF4_u6570_u7EC4-_26gt_3B_u5B57_u7B26_u4E32" class="headerlink" title="多维数组-&gt;字符串"></a>多维数组-&gt;字符串</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[[<span class="number">1</span>], <span class="number">2</span>], [<span class="number">3</span>], <span class="number">4</span>].join(); <span class="comment">// '1,2,3,4'</span></span><br></pre></td></tr></table></figure>
<h2 id="u8FD4_u56DE_u968F_u673A_u5143_u7D20"><a href="#u8FD4_u56DE_u968F_u673A_u5143_u7D20" class="headerlink" title="返回随机元素"></a>返回随机元素</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ary = [<span class="string">'male'</span>, <span class="string">'female'</span>];</span><br><span class="line"><span class="keyword">let</span> ret = ary[~~(<span class="built_in">Math</span>.random() * ary.length)];</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/javascript/">javascript</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-mac-server-cmd" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/11/mac-server-cmd/" class="article-date">
  	<time datetime="2016-04-10T22:29:46.000Z" itemprop="datePublished">2016-04-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/11/mac-server-cmd/">MAC上的各种服务命令备忘</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># start&#10;sudo /usr/local/mysql/support-files/mysql.server start&#10;# stop&#10;sudo /usr/local/mysql/support-files/mysql.server stop&#10;# restart &#10;sudo /usr/local/mysql/support-files/mysql.server restart</span><br></pre></td></tr></table></figure>
<h2 id="mongo"><a href="#mongo" class="headerlink" title="mongo"></a>mongo</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --dbpath ~/mongodb_path</span><br></pre></td></tr></table></figure>
<h2 id="orientdb"><a href="#orientdb" class="headerlink" title="orientdb"></a>orientdb</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/server.sh&#10;./bin/console.sh (or http://localhost:2424)</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mac/">mac</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongodb/">mongodb</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/">mysql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/">nginx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/orientdb/">orientdb</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/">redis</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/mac/">mac</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-orientdb-note-1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/08/orientdb-note-1/" class="article-date">
  	<time datetime="2016-04-08T09:05:56.000Z" itemprop="datePublished">2016-04-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/08/orientdb-note-1/">OrientDB学习笔记（一）</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="u4E0B_u8F7D_u3001_u5B89_u88C5_u548C_u542F_u52A8"><a href="#u4E0B_u8F7D_u3001_u5B89_u88C5_u548C_u542F_u52A8" class="headerlink" title="下载、安装和启动"></a>下载、安装和启动</h2><p>下载地址<a href="http://orientdb.com/download/" target="_blank" rel="external">http://orientdb.com/download/</a>，下载后解压进入bin目录，执行<code>./server.sh</code>命令，搞定。</p>
<p>你可以通过<a href="http://localhost:2480访问web地址，也可以执行`./console.sh`启动客户端。" target="_blank" rel="external">http://localhost:2480访问web地址，也可以执行`./console.sh`启动客户端。</a></p>
<h2 id="What"><a href="#What" class="headerlink" title="What"></a>What</h2><p>OrientDB是一款开源的非关系数据库系统，使用Java实现的，他是一个符合模型的数据库，支持文档、图和键值三种模型。记录间的关系以直接联系的方式存储在图数据库。</p>
<h2 id="u7279_u8D28"><a href="#u7279_u8D28" class="headerlink" title="特质"></a>特质</h2><p>支持ACID事务保证。<br>图数据库的管理，采用Apache的TinkerPop开源图计算框架。</p>
<p>Schema Class Cluster Record</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/orientdb/">orientdb</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/图数据库/">图数据库</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-msgpack" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/08/msgpack/" class="article-date">
  	<time datetime="2016-04-08T00:00:52.000Z" itemprop="datePublished">2016-04-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/08/msgpack/">msgpack使用记录</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>我们平时做接口调接口，总会遇到一些接口返回的数据量特别庞大的问题，这容易导致客户端流量增加，也影响响应时间。msgpack可以将数据压缩，通过<a href="http://msgpack.org/" target="_blank" rel="external">msgpack</a>，我们一般可以讲原始数据压缩一半左右，当数量很大时，非常赞！<br>步骤也很简单，如下：<br>1.安装模块<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install msgpack5 --save</span><br></pre></td></tr></table></figure></p>
<p>2.压缩/解压<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let msgpack = require(&#39;msgpack5&#39;)()&#10;  , encode  = msgpack.encode&#10;  , decode  = msgpack.decode;&#10;&#10;console.log(decode(encode(&#123; &#39;hello&#39;: &#39;world&#39; &#125;))) // &#123; hello: &#39;world&#39; &#125;</span><br></pre></td></tr></table></figure></p>
<p><code>encode</code>的结果是Buffer对象，你可以直接返回二进制编码，也可以通过toString(‘hex’)返回十六进制编码。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// &#36820;&#22238;&#20108;&#36827;&#21046;&#10;this.body = encode(&#123; &#39;hello&#39;: &#39;world&#39; &#125;);&#10;// &#36820;&#22238;&#21313;&#20845;&#36827;&#21046;&#10;this.body = encode(&#123; &#39;hello&#39;: &#39;world&#39; &#125;).toString(&#39;hex&#39;);</span><br></pre></td></tr></table></figure></p>
<p>如果你用二进制，用request测试，记得必须将encoding设为null<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request(&#123;&#10;&#9;method: &#39;post&#39;,&#10;&#9;url:&#39;http://localhost:3000/sign_in&#39;, &#10;&#9;form: &#123;account: &#39;11111121123&#39;, password: &#39;123456&#39;&#125;,&#10;&#9;encoding: null&#10;&#125;, function(err, res, body) &#123;&#10;&#9;if (err) throw err;&#10;&#9;console.log(msgpack.decode(body));&#10;&#125;)</span><br></pre></td></tr></table></figure></p>
<p>如果你用十六进制，需要将结果转为二进制后才能正常解码。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request(&#123;&#10;&#9;method: &#39;post&#39;,&#10;&#9;url:&#39;http://localhost:3000/sign_in&#39;, &#10;&#9;form: &#123;account: &#39;11111121123&#39;, password: &#39;123456&#39;&#125;,&#10;&#125;, function(err, res, body) &#123;&#10;&#9;if (err) throw err;&#10;&#9;console.log(msgpack.decode(Buffer(body, &#39;hex&#39;)));&#10;&#125;)</span><br></pre></td></tr></table></figure></p>
<p><em>注意</em> 对数据进行encode操作的时候，如果encode的内容是类似于mongoose返回的实体对象这一类的数据的话，这个对象是存在某些读写限制的，encode遇到这类数据后抛出<code>not implemented yet</code>的异常。如果是mongoose的实体对象，可以使用其内置的toObject方法将对象转换为普通对象再执行encode操作。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/msgpack/">msgpack</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/node-js/">node.js</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-highlight-build" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/06/highlight-build/" class="article-date">
  	<time datetime="2016-04-05T23:38:50.000Z" itemprop="datePublished">2016-04-06</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/06/highlight-build/">highlight使用前的构建操作</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><code>highlight</code>是一个很好的代码高亮工具，但是官方似乎没有太好的使用说明，以至于一开始使用的时候搞了有点久，这里做个简单的记录。<br>1.你需要引入css文件，这个很简单，样式文件都在<code>src/styles</code>下面<br>2.如果你跟我一样是使用bower安装的话，一开始是没有<code>highlight.pack.js</code>文件的，你需要build一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// &#20551;&#35774;&#20320;&#21482;&#38656;&#35201;javascript&#20195;&#30721;&#30340;&#39640;&#20142;&#10;node tools/build.js javascript</span><br></pre></td></tr></table></figure></p>
<p>3.之后你会看到根目录下面多了一个build的文件夹，打开就会发现<code>highlight.pack.js</code>文件了，引入该文件，再按官方指引就可以正常使用了。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/highlight/">highlight</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/javascript/">javascript</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-redis-basic" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/25/redis-basic/" class="article-date">
  	<time datetime="2016-03-25T05:34:21.000Z" itemprop="datePublished">2016-03-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/25/redis-basic/">redis基础操作指令</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>预置数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&#62; sadd user1:follow &#39;user2&#39;&#10;(integer) 1&#10;127.0.0.1:6379&#62; sadd user1:follow &#39;user3&#39;&#10;(integer) 1&#10;127.0.0.1:6379&#62; sadd user1:follow &#39;user5&#39;&#10;(integer) 1&#10;127.0.0.1:6379&#62; smembers user1:follow&#10;1) &#34;user5&#34;&#10;2) &#34;user3&#34;&#10;3) &#34;user2&#34;&#10;127.0.0.1:6379&#62; sadd user2:follow &#39;user1&#39;&#10;(integer) 1&#10;127.0.0.1:6379&#62; sadd user2:follow &#39;user4&#39;&#10;(integer) 1&#10;127.0.0.1:6379&#62; sadd user2:follow &#39;user5&#39;&#10;(integer) 1&#10;127.0.0.1:6379&#62; smembers user2:follow&#10;1) &#34;user5&#34;&#10;2) &#34;user1&#34;&#10;3) &#34;user4&#34;</span><br></pre></td></tr></table></figure></p>
<p>删除集合中的某个元素（SREM）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&#62; smembers user4:follow&#10;1) &#34;user1&#34;&#10;2) &#34;user4&#34;&#10;127.0.0.1:6379&#62; srem user4:follow user3&#10;(integer) 0&#10;127.0.0.1:6379&#62; srem user4:follow user1&#10;(integer) 1&#10;127.0.0.1:6379&#62; smembers user4:follow&#10;1) &#34;user4&#34;&#10;127.0.0.1:6379&#62;</span><br></pre></td></tr></table></figure></p>
<p>计算出两个集合的交集（SINTER）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&#62; sinter user1:follow user2:follow&#10;1) &#34;user5&#34;</span><br></pre></td></tr></table></figure></p>
<p>将一个元素从一个集合移动到另一个集合（SMOVE）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&#62; smove user2:follow user1:follow &#39;user6&#39;&#10;(integer) 0&#10;127.0.0.1:6379&#62; smembers user1:follow&#10;1) &#34;user5&#34;&#10;2) &#34;user3&#34;&#10;3) &#34;user2&#34;&#10;127.0.0.1:6379&#62; smembers user2:follow&#10;1) &#34;user5&#34;&#10;2) &#34;user1&#34;&#10;3) &#34;user4&#34;&#10;127.0.0.1:6379&#62; smove user2:follow user1:follow &#39;user5&#39;&#10;(integer) 1&#10;127.0.0.1:6379&#62; smembers user1:follow&#10;1) &#34;user5&#34;&#10;2) &#34;user3&#34;&#10;3) &#34;user2&#34;&#10;127.0.0.1:6379&#62; smembers user2:follow&#10;1) &#34;user1&#34;&#10;2) &#34;user4&#34;&#10;127.0.0.1:6379&#62; smove user2:follow user1:follow &#39;user4&#39;&#10;(integer) 1&#10;127.0.0.1:6379&#62; smembers user1:follow&#10;1) &#34;user5&#34;&#10;2) &#34;user3&#34;&#10;3) &#34;user2&#34;&#10;4) &#34;user4&#34;&#10;127.0.0.1:6379&#62; smembers user2:follow&#10;1) &#34;user1&#34;&#10;127.0.0.1:6379&#62; sinter user1:follow user2:follow&#10;(empty list or set)</span><br></pre></td></tr></table></figure></p>
<p>返回所有集合的并集（SUNION）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&#62; sunion user1:follow user2:follow&#10;1) &#34;user3&#34;&#10;2) &#34;user5&#34;&#10;3) &#34;user2&#34;&#10;4) &#34;user4&#34;&#10;5) &#34;user1&#34;</span><br></pre></td></tr></table></figure></p>
<p>返回集合的基数（SCARD）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&#62; scard user1:follow&#10;(integer) 4&#10;127.0.0.1:6379&#62; scard user2:follow&#10;(integer) 1</span><br></pre></td></tr></table></figure></p>
<p>将两个集合的交集成为另一个key的值（SINTERSTORE）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&#62; sadd user3:follow &#39;user2&#39;&#10;(integer) 1&#10;127.0.0.1:6379&#62; sadd user3:follow &#39;user4&#39;&#10;(integer) 1&#10;127.0.0.1:6379&#62; smembers user3:follow&#10;1) &#34;user2&#34;&#10;2) &#34;user4&#34;&#10;127.0.0.1:6379&#62; sinterstore user4:follow user1:follow user3:follow&#10;(integer) 2&#10;127.0.0.1:6379&#62; smembers user4:follow&#10;1) &#34;user2&#34;&#10;2) &#34;user4&#34;</span><br></pre></td></tr></table></figure></p>
<p>移除集合中的一个随机元素（SPOP）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&#62; spop user1:follow&#10;&#34;user4&#34;&#10;127.0.0.1:6379&#62; smembers user1:follow&#10;1) &#34;user5&#34;&#10;2) &#34;user3&#34;&#10;3) &#34;user2&#34;&#10;127.0.0.1:6379&#62; spop user1:follow&#10;&#34;user5&#34;&#10;127.0.0.1:6379&#62; smembers user1:follow&#10;1) &#34;user3&#34;&#10;2) &#34;user2&#34;</span><br></pre></td></tr></table></figure></p>
<p>将集合的并集作为另一个键的值（SUNIONSTORE）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&#62; sunionstore user5:follow user1:follow user2:follow user3:follow&#10;(integer) 4&#10;127.0.0.1:6379&#62; smembers user5:follow&#10;1) &#34;user3&#34;&#10;2) &#34;user1&#34;&#10;3) &#34;user2&#34;&#10;4) &#34;user4&#34;</span><br></pre></td></tr></table></figure></p>
<p>计算两个集合的差集（SDIFF）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&#62; smembers user1:follow&#10;1) &#34;user3&#34;&#10;2) &#34;user2&#34;&#10;127.0.0.1:6379&#62; sdiff user5:follow user1:follow&#10;1) &#34;user1&#34;&#10;2) &#34;user4&#34;</span><br></pre></td></tr></table></figure></p>
<p>判断一个元素是否为某个集合内的元素（ISMEMBER）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&#62; smembers user1:follow&#10;1) &#34;user3&#34;&#10;2) &#34;user2&#34;&#10;127.0.0.1:6379&#62; sismember user1:follow user1&#10;(integer) 0&#10;127.0.0.1:6379&#62; sismember user1:follow user3&#10;(integer) 1</span><br></pre></td></tr></table></figure></p>
<p>返回集合中的一个随机元素（SRANDMEMBER）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&#62; srandmember user1:follow&#10;&#34;user2&#34;</span><br></pre></td></tr></table></figure></p>
<p>计算两个集合的差集并将结果作为值赋值给一个键（SDIFFSTORE）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&#62; smembers user1:follow&#10;1) &#34;user3&#34;&#10;2) &#34;user2&#34;&#10;127.0.0.1:6379&#62; smembers user5:follow&#10;1) &#34;user3&#34;&#10;2) &#34;user1&#34;&#10;3) &#34;user2&#34;&#10;4) &#34;user4&#34;&#10;127.0.0.1:6379&#62; smembers user4:follow&#10;1) &#34;user2&#34;&#10;2) &#34;user4&#34;&#10;127.0.0.1:6379&#62; sdiffstore user4:follow user5:follow user1:follow&#10;(integer) 2&#10;127.0.0.1:6379&#62; smembers user4:follow&#10;1) &#34;user1&#34;&#10;2) &#34;user4&#34;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/">redis</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/redis/">redis</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-javascript-useful-functions" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/18/javascript-useful-functions/" class="article-date">
  	<time datetime="2016-03-18T00:55:24.000Z" itemprop="datePublished">2016-03-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/18/javascript-useful-functions/">自己写的一些常用函数</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="u968F_u673A_u5B57_u7B26_u4E32_u51FD_u6570"><a href="#u968F_u673A_u5B57_u7B26_u4E32_u51FD_u6570" class="headerlink" title="随机字符串函数"></a>随机字符串函数</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 生成随机字符串</span><br><span class="line"> *</span><br><span class="line"> * @param total 字符串长度</span><br><span class="line"> * @param method 字符串类型，数字／小写字母／大写字母</span><br><span class="line"> * @return string</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">var</span> randomString = <span class="function"><span class="keyword">function</span>(<span class="params">total, method</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> codes = [], ret = <span class="string">''</span>;</span><br><span class="line">    method = method || <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">if</span> (method &amp; randomString.number) &#123;</span><br><span class="line">        <span class="keyword">var</span> number_codes = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">10</span>).fill(<span class="number">0</span>).map(<span class="function"><span class="keyword">function</span>(<span class="params">item, index</span>) </span>&#123;<span class="keyword">return</span> <span class="number">48</span> + index;&#125;);</span><br><span class="line">        codes = codes.concat(number_codes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (method &amp; randomString.lower) &#123;</span><br><span class="line">        <span class="keyword">var</span> number_codes = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">26</span>).fill(<span class="number">0</span>).map(<span class="function"><span class="keyword">function</span>(<span class="params">item, index</span>) </span>&#123;<span class="keyword">return</span> <span class="number">97</span> + index;&#125;);</span><br><span class="line">        codes = codes.concat(number_codes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (method &amp; randomString.upper) &#123;</span><br><span class="line">        <span class="keyword">var</span> number_codes = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">26</span>).fill(<span class="number">0</span>).map(<span class="function"><span class="keyword">function</span>(<span class="params">item, index</span>) </span>&#123;<span class="keyword">return</span> <span class="number">65</span> + index;&#125;);</span><br><span class="line">        codes = codes.concat(number_codes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (total--) &#123;</span><br><span class="line">        ret += <span class="built_in">String</span>.fromCharCode(codes[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * codes.length)]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 数字</span><br><span class="line"> */</span></span><br><span class="line">randomString.number = <span class="number">1</span>;</span><br><span class="line"><span class="comment">/** </span><br><span class="line"> * 小写字母</span><br><span class="line"> */</span></span><br><span class="line">randomString.lower = <span class="number">2</span>;</span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 大写字母</span><br><span class="line"> */</span></span><br><span class="line">randomString.upper = <span class="number">4</span>;</span><br></pre></td></tr></table></figure>
<h2 id="u7EE7_u627F_u51FD_u6570"><a href="#u7EE7_u627F_u51FD_u6570" class="headerlink" title="继承函数"></a>继承函数</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> extend = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> params = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>),</span><br><span class="line">        method = <span class="string">'number'</span> == <span class="keyword">typeof</span> params[params.length - <span class="number">1</span>] ? params.pop() : <span class="number">0</span>,</span><br><span class="line">        ret = method &amp; extend.replaceFirst ? params.shift() : &#123;&#125;,</span><br><span class="line">        deep = method &amp; extend.deepExtend,</span><br><span class="line">        rmNull = method &amp; extend.removeNull,</span><br><span class="line">        obj;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (params.length) &#123;</span><br><span class="line">        obj = params.shift();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> k <span class="keyword">in</span> obj) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> === obj[k]) &#123;</span><br><span class="line">                rmNull ? <span class="keyword">delete</span> ret[k] : ret[k] = obj[k];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!ret[k] || ret[k].constructor !== <span class="built_in">Object</span> || obj[k].constructor !== <span class="built_in">Object</span>) &#123;</span><br><span class="line">                ret[k] = obj[k];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ret[k] = deep ? extend(ret[k], obj[k], method) : obj[k];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 将结果赋值给第一个对象</span><br><span class="line"> */</span></span><br><span class="line">extend.replaceFirst = extend.RF = <span class="number">1</span>;</span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 深度合并</span><br><span class="line"> */</span></span><br><span class="line">extend.deepExtend = extend.DE = <span class="number">2</span>;</span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 删除值为null的键</span><br><span class="line"> */</span></span><br><span class="line">extend.removeNull = extend.RN = <span class="number">4</span>;</span><br></pre></td></tr></table></figure>
<h2 id="u5B57_u7B26_u4E32_u53CA_u65F6_u95F4_u683C_u5F0F_u5316_u51FD_u6570"><a href="#u5B57_u7B26_u4E32_u53CA_u65F6_u95F4_u683C_u5F0F_u5316_u51FD_u6570" class="headerlink" title="字符串及时间格式化函数"></a>字符串及时间格式化函数</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 字符串格式化方法</span><br><span class="line"> * @params null</span><br><span class="line"> * @example _.format('我是&#123;0&#125;', 'CoderQ') =&gt; '我是CoderQ'; '我是&#123;name&#125;'.format(&#123;name:'CoderQ'&#125;) =&gt; '我是CoderQ';</span><br><span class="line"> * @depends null</span><br><span class="line"> * @return string</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">var</span> string_format = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>),</span><br><span class="line">        string = args.shift(),</span><br><span class="line">        params = <span class="string">'object'</span> == <span class="keyword">typeof</span> args[<span class="number">0</span>] ? args[<span class="number">0</span>] : args;</span><br><span class="line">    <span class="keyword">return</span> string.replace(<span class="regexp">/\&#123;(\w+)(\|([^&#125;]+))?\&#125;/g</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$, $1, $2, $3</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'undefined'</span> == <span class="keyword">typeof</span> params[$<span class="number">1</span>] ? <span class="built_in">eval</span>($<span class="number">3</span>) : params[$<span class="number">1</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 时间格式化函数</span><br><span class="line"> * @params</span><br><span class="line"> *    format 格式</span><br><span class="line"> *    language 语言</span><br><span class="line"> * @example new Date().format('Y-m-d H:i:s')</span><br><span class="line"> * @depends toString</span><br><span class="line"> * @return string</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">var</span> date_format = <span class="function"><span class="keyword">function</span>(<span class="params">format, date, lang</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _format = format || <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> _lang = lang || <span class="string">'zh'</span>;</span><br><span class="line">    <span class="keyword">var</span> _month_text = &#123;</span><br><span class="line">        <span class="string">'zh'</span>: [<span class="string">'一'</span>, <span class="string">'二'</span>, <span class="string">'三'</span>, <span class="string">'四'</span>, <span class="string">'五'</span>, <span class="string">'六'</span>, <span class="string">'七'</span>, <span class="string">'八'</span>, <span class="string">'九'</span>, <span class="string">'十'</span>, <span class="string">'十一'</span>, <span class="string">'十二'</span>],</span><br><span class="line">        <span class="string">'en'</span>: [<span class="string">'Jan'</span>, <span class="string">'Feb'</span>, <span class="string">'Mar'</span>, <span class="string">'Apr'</span>, <span class="string">'May'</span>, <span class="string">'Jun'</span>, <span class="string">'Jul'</span>, <span class="string">'Aug'</span>, <span class="string">'Sep'</span>, <span class="string">'Oct'</span>, <span class="string">'Nov'</span>, <span class="string">'Dec'</span>]</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> _day_text = &#123;</span><br><span class="line">        <span class="string">'zh'</span>: [<span class="string">'日'</span>, <span class="string">'一'</span>, <span class="string">'二'</span>, <span class="string">'三'</span>, <span class="string">'四'</span>, <span class="string">'五'</span>, <span class="string">'六'</span>],</span><br><span class="line">        <span class="string">'en'</span>: [<span class="string">'Sun'</span>, <span class="string">'Mon'</span>, <span class="string">'Tues'</span>, <span class="string">'Wed'</span>, <span class="string">'Thur'</span>, <span class="string">'Fri'</span>, <span class="string">'Sat'</span>]</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> _year = date.getFullYear();</span><br><span class="line">    <span class="keyword">var</span> _month = date.getMonth() + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> _date = date.getDate();</span><br><span class="line">    <span class="keyword">var</span> _day = date.getDay();</span><br><span class="line">    <span class="keyword">var</span> _hour = date.getHours();</span><br><span class="line">    <span class="keyword">var</span> _minute = date.getMinutes();</span><br><span class="line">    <span class="keyword">var</span> _second = date.getSeconds();</span><br><span class="line">    <span class="keyword">return</span> _format.replace(<span class="regexp">/Y/g</span>, _year)</span><br><span class="line">        .replace(<span class="regexp">/y/g</span>, _year.toString().substr(<span class="number">2</span>))</span><br><span class="line">        .replace(<span class="regexp">/M/g</span>, _month_text[_lang][_month - <span class="number">1</span>])</span><br><span class="line">        .replace(<span class="regexp">/m/g</span>, _month &gt; <span class="number">9</span> ? _month : <span class="string">'0'</span> + _month)</span><br><span class="line">        .replace(<span class="regexp">/n/g</span>, _month)</span><br><span class="line">        .replace(<span class="regexp">/D/g</span>, _day_text[_lang][_day])</span><br><span class="line">        .replace(<span class="regexp">/d/g</span>, _date &gt; <span class="number">9</span> ? _date : <span class="string">'0'</span> + _date)</span><br><span class="line">        .replace(<span class="regexp">/j/g</span>, _date)</span><br><span class="line">        .replace(<span class="regexp">/H/g</span>, _hour &gt; <span class="number">9</span> ? _hour : <span class="string">'0'</span> + _hour)</span><br><span class="line">        .replace(<span class="regexp">/G/g</span>, _hour)</span><br><span class="line">        .replace(<span class="regexp">/h/g</span>, (_hour % <span class="number">12</span>) &gt; <span class="number">9</span> ? (_hour % <span class="number">12</span>) : <span class="string">'0'</span> + (_hour % <span class="number">12</span>))</span><br><span class="line">        .replace(<span class="regexp">/g/g</span>, _hour % <span class="number">12</span>)</span><br><span class="line">        .replace(<span class="regexp">/i/g</span>, _minute &gt; <span class="number">9</span> ? _minute : <span class="string">'0'</span> + _minute)</span><br><span class="line">        .replace(<span class="regexp">/s/g</span>, _second &gt; <span class="number">9</span> ? _second : <span class="string">'0'</span> + _second);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 数据格式化</span><br><span class="line"> * @param format</span><br><span class="line"> * @param obj</span><br><span class="line"> * @return string</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">var</span> format = <span class="function"><span class="keyword">function</span>(<span class="params">format, obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.toString.call(obj) == <span class="string">'[object Date]'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> date_format.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> string_format.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/javascript/">javascript</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 CoderQ
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>